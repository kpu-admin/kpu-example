
/**
 * 由 admin 提供技术支持
 * Powered by admin
 * 代码仓库
 * Github https://github.com/Lmx1220/kpu-web
 */
    
var ze=Object.defineProperty;var He=(e,t,n)=>t in e?ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var E=(e,t,n)=>He(e,typeof t!="symbol"?t+"":t,n);import{d as A,B as We,f as _,o as w,w as C,y as R,O as D,j as u,P as Ke,c as y,R as I,n as Z,a0 as Ye,ac as ve,m as Me,bJ as Ge,bK as Je,bL as Qe,aV as se,bM as k,bN as he,bO as Xe,bP as Ne,bQ as ye,bR as et,bS as tt,a5 as nt,a6 as Ae,b as x,e as me,V as ue,v as X,i as z,p as st,A as Te,U as ot,bT as Y,bU as at,z as oe,h as $,F as be,a4 as ce,s as Le,bV as rt,r as H,bW as Se,bX as lt,ba as je,Y as it,Z as ut,bo as Ze,q as Be,L as W,M as K,T as ct,K as ge,bY as dt,H as xe,bZ as mt,b_ as ft,J as pt,b$ as ht,bm as vt,c0 as bt,c1 as gt,ag as yt,$ as Ee}from"./bootstrap-DTzpk8a9.js";import{_ as wt}from"./index.vue_vue_type_script_setup_true_lang-BW889TwX.js";import{_ as Ct}from"./index.vue_vue_type_script_setup_true_lang-Cdx9uZmh.js";import{_ as Ft}from"./index.vue_vue_type_script_setup_true_lang-CPI8r6AN.js";import{d as St,e as Rt,z as F,u as Vt,o as _t,f as qe,g as Pt,t as Bt,F as Ot,a as $t,c as kt,_ as Mt,h as Nt}from"./vee-validate-zod-CALzD3H0.js";import{_ as Et}from"./FormDescription.vue_vue_type_script_setup_true_lang-BYn0-Kpy.js";class Dt{constructor(){E(this,"condition",!1);E(this,"rejectCondition",null);E(this,"resolveCondition",null)}isConditionTrue(){return this.condition}reset(){this.condition=!1,this.clearPromises()}setConditionFalse(){this.condition=!1,this.rejectCondition&&(this.rejectCondition(),this.clearPromises())}setConditionTrue(){this.condition=!0,this.resolveCondition&&(this.resolveCondition(),this.clearPromises())}waitForCondition(){return new Promise((t,n)=>{this.condition?t():(this.resolveCondition=t,this.rejectCondition=n)})}clearPromises(){this.resolveCondition=null,this.rejectCondition=null}}const It=A({__name:"Label",props:{for:{},asChild:{type:Boolean},as:{default:"label"}},setup(e){const t=e;return We(),(n,s)=>(w(),_(u(Ke),D(t,{onMousedown:s[0]||(s[0]=a=>{!a.defaultPrevented&&a.detail>1&&a.preventDefault()})}),{default:C(()=>[R(n.$slots,"default")]),_:3},16))}}),At=A({__name:"Label",props:{for:{},asChild:{type:Boolean},as:{},class:{}},setup(e){const t=e,n=y(()=>{const{class:s,...a}=t;return a});return(s,a)=>(w(),_(u(It),D(n.value,{class:u(I)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",t.class)}),{default:C(()=>[R(s.$slots,"default")]),_:3},16,["class"]))}}),Tt=A({__name:"FormLabel",props:{for:{},asChild:{type:Boolean},as:{},class:{}},setup(e){const t=e,{error:n,formItemId:s}=St();return(a,l)=>(w(),_(u(At),{class:Z(u(I)(u(n)&&"text-destructive",t.class)),for:u(s)},{default:C(()=>[R(a.$slots,"default")]),_:3},8,["class","for"]))}}),De="modelValue",Ue={},de={DefaultButton:ve(Me,{size:"sm",variant:"outline"}),PrimaryButton:ve(Me,{size:"sm",variant:"default"}),KpuCheckbox:wt,KpuInput:Ye,KpuPinInput:Ct,KpuSelect:Ft},Ve={KCheckbox:"checked"};function Lt(e){const{config:t,defineRules:n}=e,{disabledOnChangeListener:s=!0,disabledOnInputListener:a=!0,emptyStateValue:l=void 0}=t||{};if(Object.assign(Ue,{disabledOnChangeListener:s,disabledOnInputListener:a,emptyStateValue:l}),n)for(const d of Object.keys(n))Rt(d,n[d]);const c=(t==null?void 0:t.baseModelPropName)??De,o=t==null?void 0:t.modelPropNameMap,i=Ge.getComponents();for(const d of Object.keys(i)){const m=d;de[m]=i[d],c!==De&&(Ve[m]=c),o&&o[m]&&(Ve[m]=o[m])}}function jt(){return{actionWrapperClass:"",collapsed:!1,collapsedRows:1,collapseTriggerResize:!1,commonConfig:{},handleReset:void 0,handleSubmit:void 0,handleValuesChange:void 0,layout:"horizontal",resetButtonOptions:{},schema:[],showCollapseButton:!1,showDefaultActions:!0,submitButtonOptions:{},submitOnChange:!1,submitOnEnter:!1,wrapperClass:"grid-cols-1"}}class Zt{constructor(t={}){E(this,"form",{});E(this,"isMounted",!1);E(this,"state",null);E(this,"stateHandler");E(this,"store");E(this,"latestSubmissionValues",null);E(this,"prevState",null);E(this,"handleRangeTimeValue",t=>{var a;const n={...t},s=(a=this.state)==null?void 0:a.fieldMappingTime;return!s||!Array.isArray(s)||s.forEach(([l,[c,o],i="YYYY-MM-DD"])=>{if(c&&o&&n[l]===null&&(Reflect.deleteProperty(n,c),Reflect.deleteProperty(n,o)),!n[l]){Reflect.deleteProperty(n,l);return}const[d,m]=n[l];if(i===null)n[c]=d,n[o]=m;else if(k(i))n[c]=i(d,c),n[o]=i(m,o);else{const[h,v]=Array.isArray(i)?i:[i,i];n[c]=d?Ne(d,h):void 0,n[o]=m?Ne(m,v):void 0}Reflect.deleteProperty(n,l)}),n});const{...n}=t,s=jt();this.store=new Je({...s,...n},{onUpdate:()=>{this.prevState=this.state,this.state=this.store.state,this.updateState()}}),this.state=this.store.state,this.stateHandler=new Dt,Qe(this)}getLatestSubmissionValues(){return this.latestSubmissionValues||{}}getState(){return this.state}async getValues(){const t=await this.getForm();return t.values?this.handleRangeTimeValue(t.values):{}}async isFieldValid(t){return(await this.getForm()).isFieldValid(t)}merge(t){const n=[this,t],s=new Proxy(t,{get(a,l){return l==="merge"?c=>(n.push(c),s):l==="submitAllForm"?async(c=!0)=>{try{const o=await Promise.all(n.map(async i=>(await i.validate()).valid?se(await i.getValues()||{}):void 0));return c?Object.assign({},...o):o}catch(o){console.error("Validation error:",o)}}:a[l]}});return s}mount(t){this.isMounted||(Object.assign(this.form,t),this.stateHandler.setConditionTrue(),this.setLatestSubmissionValues({...se(this.handleRangeTimeValue(this.form.values))}),this.isMounted=!0)}async removeSchemaByFields(t){var l;const n=new Set(t),a=(((l=this.state)==null?void 0:l.schema)??[]).filter(c=>!n.has(c.fieldName));this.setState({schema:a})}async resetForm(t,n){return(await this.getForm()).resetForm(t,n)}async resetValidate(){const t=await this.getForm();Object.keys(t.errors.value).forEach(s=>{t.setFieldError(s,void 0)})}async setFieldValue(t,n,s){(await this.getForm()).setFieldValue(t,n,s)}setLatestSubmissionValues(t){this.latestSubmissionValues={...se(t)}}setState(t){k(t)?this.store.setState(n=>he(t(n),n)):this.store.setState(n=>he(t,n))}async setValues(t,n=!0,s=!1){const a=await this.getForm();if(!n){a.setValues(t,s);return}const l=Xe((o,i,d)=>(i in o&&(o[i]=!Array.isArray(o[i])&&ye(o[i])&&!et(o[i])&&!tt(o[i])?l(o[i],d):d),!0)),c=l(t,a.values);a.setValues(c,s)}async submitForm(t){var a,l;t==null||t.preventDefault(),t==null||t.stopPropagation(),await(await this.getForm()).submitForm();const s=se(await this.getValues());return await((l=(a=this.state)==null?void 0:a.handleSubmit)==null?void 0:l.call(a,s)),s}unmount(){var t,n;(n=(t=this.form)==null?void 0:t.resetForm)==null||n.call(t),this.latestSubmissionValues=null,this.isMounted=!1,this.stateHandler.reset()}updateSchema(t){var c;const n=[...t];if(!n.every(o=>Reflect.has(o,"fieldName")&&o.fieldName)){console.error("All items in the schema array must have a valid `fieldName` property to be updated");return}const a=[...((c=this.state)==null?void 0:c.schema)??[]],l={};n.forEach(o=>{o.fieldName&&(l[o.fieldName]=o)}),a.forEach((o,i)=>{const d=l[o.fieldName];d&&(a[i]=he(d,o))}),this.setState({schema:a})}async validate(t){const s=await(await this.getForm()).validate(t);return Object.keys((s==null?void 0:s.errors)??{}).length>0&&console.error("validate error",s==null?void 0:s.errors),s}async validateAndSubmitForm(){const t=await this.getForm(),{valid:n}=await t.validate();if(n)return await this.submitForm()}async validateField(t,n){const a=await(await this.getForm()).validateField(t,n);return Object.keys((a==null?void 0:a.errors)??{}).length>0&&console.error("validate error",a==null?void 0:a.errors),a}async getForm(){var t;if(this.isMounted||await this.stateHandler.waitForCondition(),!((t=this.form)!=null&&t.meta))throw new Error("<KpuForm /> is not mounted");return this.form}updateState(){var s,a,l,c;const t=((s=this.state)==null?void 0:s.schema)??[],n=((a=this.prevState)==null?void 0:a.schema)??[];if(t.length<n.length){const o=new Set(t.map(d=>d.fieldName)),i=n.filter(d=>!o.has(d.fieldName));for(const d of i)(c=(l=this.form)==null?void 0:l.setFieldValue)==null||c.call(l,d.fieldName,void 0)}}}const xt=A({__name:"index",props:nt({class:{}},{modelValue:{default:!1},modelModifiers:{}}),emits:["update:modelValue"],setup(e){const t=e,n=Ae(e,"modelValue");return(s,a)=>{const l=st;return w(),x("div",{class:Z(u(I)("cursor-pointer color-primary inline-flex items-center",t.class)),onClick:a[0]||(a[0]=c=>n.value=!n.value)},[R(s.$slots,"default",{isExpanded:n.value},()=>[ue(X(n.value),1)]),me("div",{class:Z([{"rotate-180":!n.value},"transition-transform duration-300"])},[R(s.$slots,"icon",{},()=>[z(l,{name:"i-lucide:chevron-down",class:"size-4"})])],2)],2)}}}),Q=(e,t)=>e.constructor.name===t.name,B=new Map;B.set(F.ZodBoolean.name,()=>!1),B.set(F.ZodNumber.name,()=>0),B.set(F.ZodString.name,()=>""),B.set(F.ZodArray.name,()=>[]),B.set(F.ZodRecord.name,()=>({})),B.set(F.ZodDefault.name,e=>e._def.defaultValue()),B.set(F.ZodEffects.name,e=>ie(e._def.schema)),B.set(F.ZodOptional.name,e=>Q(e._def.innerType,F.ZodDefault)?e._def.innerType._def.defaultValue():void 0),B.set(F.ZodTuple.name,e=>{const t=[];for(const n of e._def.items)t.push(ie(n));return t}),B.set(F.ZodEffects.name,e=>ie(e._def.schema)),B.set(F.ZodUnion.name,e=>ie(e._def.options[0])),B.set(F.ZodObject.name,e=>G(e)),B.set(F.ZodRecord.name,e=>G(e)),B.set(F.ZodIntersection.name,e=>G(e));function ie(e){const t=e.constructor.name;if(!B.has(t)){console.warn("getSchemaDefaultForField: Unhandled type",e.constructor.name);return}return B.get(t)(e)}function G(e){if(Q(e,F.ZodRecord))return{};if(Q(e,F.ZodEffects))return G(e._def.schema);if(Q(e,F.ZodIntersection))return{...G(e._def.left),...G(e._def.right)};if(Q(e,F.ZodUnion)){for(const t of e._def.options)if(Q(t,F.ZodObject))return G(t);return console.warn("getSchemaDefaultObject: No object found in union, returning empty object"),{}}return Q(e,F.ZodObject)?Object.fromEntries(Object.entries(e.shape).map(([t,n])=>[t,ie(n)]).filter(t=>t[1]!==void 0)):(console.warn(`getSchemaDefaultObject: Expected object schema, got ${e.constructor.name}`),{})}function qt(e){return G(e)}const[Ut,zt]=Te("KpuFormProps");function Ht(e){var c;const t=ot(),n=l(),s=Vt({...(c=Object.keys(n))!=null&&c.length?{initialValues:n}:{}}),a=y(()=>{const o=[];for(const i of Object.keys(t))i!=="default"&&o.push(i);return o});function l(){const o={},i={};(u(e).schema||[]).forEach(m=>{Reflect.has(m,"defaultValue")?o[m.fieldName]=m.defaultValue:m.rules&&!Y(m.rules)&&(i[m.fieldName]=m.rules)});const d=qt(_t(i));return{...o,...d}}return{delegatedSlots:a,form:s}}const Wt=A({__name:"form-actions",props:{modelValue:{default:!1},modelModifiers:{}},emits:["update:modelValue"],setup(e,{expose:t}){const{$t:n}=at(),[s,a]=Ut(),l=Ae(e,"modelValue"),c=y(()=>({content:`${n.value("reset")}`,show:!0,...u(s).resetButtonOptions})),o=y(()=>({content:`${n.value("submit")}`,show:!0,...u(s).submitButtonOptions})),i=y(()=>u(s).actionWrapperClass?{}:{"grid-column":"-2 / -1",marginLeft:"auto"});async function d(h){var p,b,g;h==null||h.preventDefault(),h==null||h.stopPropagation();const{valid:v}=await a.validate();if(!v)return;const f=se(await((p=u(s).formApi)==null?void 0:p.getValues()));await((g=(b=u(s)).handleSubmit)==null?void 0:g.call(b,f))}async function m(h){var p,b;h==null||h.preventDefault(),h==null||h.stopPropagation();const v=u(s),f=se((p=v.formApi)==null?void 0:p.getValues());k(v.handleReset)?await((b=v.handleReset)==null?void 0:b.call(v,f)):a.resetForm()}return oe(()=>l.value,()=>{u(s).collapseTriggerResize&&rt()}),t({handleReset:m,handleSubmit:d}),(h,v)=>{const f=xt;return w(),x("div",{class:Z(u(I)("col-span-full w-full text-right",u(s).compact?"pb-2":"pb-6",u(s).actionWrapperClass)),style:Le(i.value)},[u(s).actionButtonsReverse?(w(),x(be,{key:0},[R(h.$slots,"submit-before"),o.value.show?(w(),_(ce(u(de).PrimaryButton),D({key:0,class:"ml-3",type:"button"},o.value,{onClick:d}),{default:C(()=>[ue(X(o.value.content),1)]),_:1},16)):$("",!0)],64)):$("",!0),R(h.$slots,"reset-before"),c.value.show?(w(),_(ce(u(de).DefaultButton),D({key:1,class:"ml-3",type:"button"},c.value,{onClick:m}),{default:C(()=>[ue(X(c.value.content),1)]),_:1},16)):$("",!0),u(s).actionButtonsReverse?$("",!0):(w(),x(be,{key:2},[R(h.$slots,"submit-before"),o.value.show?(w(),_(ce(u(de).PrimaryButton),D({key:0,class:"ml-3",type:"button"},o.value,{onClick:d}),{default:C(()=>[ue(X(o.value.content),1)]),_:1},16)):$("",!0)],64)),R(h.$slots,"expand-before"),u(s).showCollapseButton?(w(),_(f,{key:3,"model-value":l.value,"onUpdate:modelValue":v[0]||(v[0]=p=>l.value=p),class:"ml-2"},{default:C(()=>[me("span",null,X(l.value?u(n)("expand"):u(n)("collapse")),1)]),_:1},8,["model-value"])):$("",!0),R(h.$slots,"expand-after")],6)}}}),Re=A({name:"RenderContent",props:{content:{default:void 0,type:[Object,String,Function]}},setup(e,{attrs:t,slots:n}){return()=>e.content?(ye(e.content)||k(e.content))&&e.content!==null?ve(e.content,{...t,props:{...e,...t},slots:n}):e.content:null}}),[Oe,Kt]=Te("FormRenderProps");function Yt(){const e=Oe(),t=y(()=>e.layout==="vertical"),n=y(()=>e.componentMap);return{componentBindEventMap:y(()=>e.componentBindEventMap),componentMap:n,isVertical:t}}function Gt(e){const t=qe(),s=Oe().form;if(!t)throw new Error("useDependencies should be used within <KpuForm>");const a=H(!0),l=H(!1),c=H(!0),o=H(!1),i=H({}),d=H(),m=y(()=>{var f;return(((f=e())==null?void 0:f.triggerFields)??[]).map(p=>t.value[p])}),h=()=>{l.value=!1,a.value=!0,c.value=!0,o.value=!1,d.value=void 0,i.value={}};return oe([m,e],async([v,f])=>{var ee;if(!f||!((ee=f==null?void 0:f.triggerFields)!=null&&ee.length))return;h();const{componentProps:p,disabled:b,if:g,required:M,rules:T,show:S,trigger:J}=f,N=t.value;if(k(g)){if(a.value=!!await g(N,s),!a.value)return}else if(Se(g)&&(a.value=g,!a.value))return;if(k(S)){if(c.value=!!await S(N,s),!c.value)return}else if(Se(S)&&(c.value=S,!c.value))return;k(p)&&(i.value=await p(N,s)),k(T)&&(d.value=await T(N,s)),k(b)?l.value=!!await b(N,s):Se(b)&&(l.value=b),k(M)&&(o.value=!!await M(N,s)),k(J)&&await J(N,s)},{deep:!0,immediate:!0}),{dynamicComponentProps:i,dynamicRules:d,isDisabled:l,isIf:a,isRequired:o,isShow:c}}const Jt={key:0,class:"mr-[2px] text-destructive"},Qt=A({__name:"form-label",props:{class:{},help:{},required:{type:Boolean}},setup(e){const t=e;return(n,s)=>(w(),_(u(Tt),{class:Z(u(I)("flex items-center",t.class))},{default:C(()=>[n.required?(w(),x("span",Jt,"*")):$("",!0),R(n.$slots,"default"),n.help?(w(),_(lt,{key:1,"trigger-class":"size-3.5 ml-1"},{default:C(()=>[ue(X(n.help),1)]),_:1})):$("",!0)]),_:3},8,["class"]))}});function _e(e){return!e||Y(e)?null:"innerType"in e._def?_e(e._def.innerType):"schema"in e._def?_e(e._def.schema):e}function Pe(e){if(!e||Y(e))return;const t=e;if(t._def.typeName==="ZodDefault")return t._def.defaultValue();if("innerType"in t._def)return Pe(t._def.innerType);if("schema"in t._def)return Pe(t._def.schema)}function Ie(e){return!e||!ye(e)?!1:Reflect.has(e,"target")&&Reflect.has(e,"stopPropagation")}const Xt={key:0,class:"ml-[2px]"},en={key:0,class:"ml-1"},tn=A({__name:"form-field",props:{component:{},componentProps:{type:Function},defaultValue:{},dependencies:{},description:{},fieldName:{},help:{},label:{},renderComponentContent:{type:Function},rules:{},suffix:{type:[Function,String]},colon:{type:Boolean},controlClass:{},disabled:{type:Boolean},disabledOnChangeListener:{type:Boolean},disabledOnInputListener:{type:Boolean},emptyStateValue:{},formFieldProps:{},formItemClass:{},hideLabel:{type:Boolean},hideRequiredMark:{type:Boolean},labelClass:{},labelWidth:{},modelPropName:{},wrapperClass:{},commonComponentProps:{}},setup(e){const{componentBindEventMap:t,componentMap:n,isVertical:s}=Yt(),a=Oe(),l=qe(),c=Pt(e.fieldName),o=je("fieldComponentRef"),i=a.form,d=a.compact,m=y(()=>{var r;return((r=c.value)==null?void 0:r.length)>0}),h=y(()=>{const r=Y(e.component)?n.value[e.component]:e.component;return r||console.warn(`Component ${e.component} is not registered`),r}),{dynamicComponentProps:v,dynamicRules:f,isDisabled:p,isIf:b,isRequired:g,isShow:M}=Gt(()=>e.dependencies),T=y(()=>{var r;return(r=e.labelClass)!=null&&r.includes("w-")||s.value?{}:{width:`${e.labelWidth}px`}}),S=y(()=>f.value||e.rules),J=y(()=>b.value&&M.value),N=y(()=>{var O,P,U,re,le,j;if(!J.value)return!1;if(!S.value)return g.value;if(g.value)return!0;if(Y(S.value))return["required","selectRequired"].includes(S.value);let r=(P=(O=S==null?void 0:S.value)==null?void 0:O.isOptional)==null?void 0:P.call(O);if(((re=(U=S==null?void 0:S.value)==null?void 0:U._def)==null?void 0:re.typeName)==="ZodDefault"){const te=(le=S==null?void 0:S.value)==null?void 0:le._def.innerType;te&&(r=(j=te.isOptional)==null?void 0:j.call(te))}return!r}),ee=y(()=>{var O;if(!J.value)return null;let r=S.value;if(!r)return g.value?"required":null;if(Y(r))return r;if(!!N.value){const P=(O=r==null?void 0:r.unwrap)==null?void 0:O.call(r);P&&(r=P)}return Bt(r)}),L=y(()=>{const r=k(e.componentProps)?e.componentProps(l.value,i):e.componentProps;return{...e.commonComponentProps,...r,...v.value}});oe(()=>{var r;return(r=L.value)==null?void 0:r.autofocus},r=>{r===!0&&ge(()=>{Fe()})},{immediate:!0});const fe=y(()=>{var r;return p.value||e.disabled||((r=L.value)==null?void 0:r.disabled)}),pe=y(()=>k(e.renderComponentContent)?e.renderComponentContent(l.value,i):{}),we=y(()=>Object.keys(pe.value)),q=y(()=>{const r=ee.value;return{keepValue:!0,label:e.label,...r?{rules:r}:{},...e.formFieldProps}});function Ce(r){var re,le;const V=r.componentField.modelValue,O=r.componentField["onUpdate:modelValue"],P=e.modelPropName||(Y(e.component)?(re=t.value)==null?void 0:re[e.component]:null);let U=V;return V&&ye(V)&&P&&(U=Ie(V)?(le=V==null?void 0:V.target)==null?void 0:le[P]:(V==null?void 0:V[P])??V),P?{[`onUpdate:${P}`]:O,[P]:U===void 0?e.emptyStateValue:U,onChange:e.disabledOnChangeListener?void 0:j=>{var $e,ke;const te=Ie(j),ne=($e=r==null?void 0:r.componentField)==null?void 0:$e.onChange;return te?ne==null?void 0:ne(((ke=j==null?void 0:j.target)==null?void 0:ke[P])??j):ne==null?void 0:ne(j)},...e.disabledOnInputListener?{onInput:void 0}:{}}:{...e.disabledOnInputListener?{onInput:void 0}:{},...e.disabledOnChangeListener?{onChange:void 0}:{}}}function ae(r){const V=Ce(r);return{...r.componentField,...L.value,...V,...Reflect.has(L.value,"onChange")?{onChange:L.value.onChange}:{},...Reflect.has(L.value,"onInput")?{onInput:L.value.onInput}:{}}}function Fe(){var r,V;o.value&&k(o.value.focus)&&document.activeElement!==o.value&&((V=(r=o.value)==null?void 0:r.focus)==null||V.call(r))}return(r,V)=>u(b)?(w(),_(u(Ot),D({key:0},q.value,{name:r.fieldName}),{default:C(O=>[it(z(u(Mt),D({class:[{"form-valid-error":m.value,"flex-col":u(s),"flex-row items-center":!u(s),"pb-6":!u(d),"pb-2":u(d)},"flex"]},r.$attrs),{default:C(()=>[r.hideLabel?$("",!0):(w(),_(Qt,{key:0,class:Z(u(I)("flex leading-6",{"mr-2 flex-shrink-0 justify-end":!u(s),"mb-1 flex-row":u(s)},r.labelClass)),help:r.help,required:N.value&&!r.hideRequiredMark,style:Le(T.value)},{default:C(()=>[r.label?(w(),x(be,{key:0},[me("span",null,X(r.label),1),r.colon?(w(),x("span",Xt,":")):$("",!0)],64)):$("",!0)]),_:1},8,["class","help","required","style"])),me("div",{class:Z(u(I)("relative flex w-full items-center",r.wrapperClass))},[z(u($t),{class:Z(u(I)(r.controlClass))},{default:C(()=>[R(r.$slots,"default",W(K({...O,...ae(O),disabled:fe.value,isInValid:m.value})),()=>[(w(),_(ce(h.value),D({ref_key:"fieldComponentRef",ref:o,class:{"border-destructive focus:border-destructive hover:border-destructive/80 focus:shadow-[0_0_0_2px_rgba(255,38,5,0.06)]":m.value}},ae(O),{disabled:fe.value}),Ze({_:2},[Be(we.value,P=>({name:P,fn:C(U=>[z(Re,D({content:pe.value[P]},{...U,$formContext:O}),null,16,["content"])])}))]),1040,["class","disabled"]))])]),_:2},1032,["class"]),r.suffix?(w(),x("div",en,[z(Re,{content:r.suffix},null,8,["content"])])):$("",!0),r.description?(w(),_(u(Et),{key:1},{default:C(()=>[z(Re,{content:r.description},null,8,["content"])]),_:1})):$("",!0),z(ct,{name:"slide-up"},{default:C(()=>[z(u(kt),{class:"absolute -bottom-[22px]"})]),_:1})],2)]),_:2},1040,["class"]),[[ut,u(M)]])]),_:3},16,["name"])):$("",!0)}});function nn(e){const t=je("wrapperRef"),n=H({}),s=H(!1),a=dt(mt),l=y(()=>{const o=e.collapsedRows??1,i=n.value;let d=0;for(let m=1;m<=o;m++)d+=(i==null?void 0:i[m])??0;return d-1||1});oe([()=>e.showCollapseButton,()=>a.active().value,()=>{var o;return(o=e.schema)==null?void 0:o.length}],async([o])=>{o&&(await ge(),n.value={},s.value=!1,await c())});async function c(){if(!e.showCollapseButton||(await ge(),!t.value))return;const o=[...t.value.children],i=t.value,m=window.getComputedStyle(i).getPropertyValue("grid-template-rows").split(" "),h=i==null?void 0:i.getBoundingClientRect();o.forEach(v=>{const p=v.getBoundingClientRect().top-h.top;let b=0,g=0;for(const[M,T]of m.entries())if(g+=Number.parseFloat(T),p<g){b=M+1;break}b>((e==null?void 0:e.collapsedRows)??1)||(n.value[b]=(n.value[b]??0)+1,s.value=!0)})}return xe(()=>{c()}),{isCalculated:s,keepFormItemIndex:l,wrapperRef:t}}const sn=A({__name:"form",props:{collapsed:{type:Boolean},collapsedRows:{default:1},collapseTriggerResize:{type:Boolean},commonConfig:{default:()=>({})},compact:{type:Boolean},componentBindEventMap:{},componentMap:{},form:{},layout:{},schema:{},showCollapseButton:{type:Boolean,default:!1},wrapperClass:{default:"grid-cols-1 sm:grid-cols-2 md:grid-cols-3"},globalCommonConfig:{default:()=>({})}},emits:["submit"],setup(e,{emit:t}){const n=e,s=t;Kt(n);const{isCalculated:a,keepFormItemIndex:l,wrapperRef:c}=nn(n),o=y(()=>{var f;const v=[];return(f=n.schema)==null||f.forEach(p=>{const{fieldName:b}=p,g=p.rules;let M="";g&&!Y(g)&&(M=g._def.typeName);const T=_e(g);v.push({default:Pe(g),fieldName:b,required:!["ZodNullable","ZodOptional"].includes(M),rules:T})}),v}),i=y(()=>n.form?"form":Nt),d=y(()=>n.form?{onSubmit:n.form.handleSubmit(v=>s("submit",v))}:{onSubmit:v=>s("submit",v)}),m=y(()=>n.collapsed&&a.value),h=y(()=>{const{colon:v=!1,componentProps:f={},controlClass:p="",disabled:b,disabledOnChangeListener:g=!0,disabledOnInputListener:M=!0,emptyStateValue:T=void 0,formFieldProps:S={},formItemClass:J="",hideLabel:N=!1,hideRequiredMark:ee=!1,labelClass:L="",labelWidth:fe=100,modelPropName:pe="",wrapperClass:we=""}=he(n.commonConfig,n.globalCommonConfig);return(n.schema||[]).map((q,Ce)=>{const ae=l.value,Fe=n.showCollapseButton&&m.value&&ae?ae<=Ce:!1;return{colon:v,disabled:b,disabledOnChangeListener:g,disabledOnInputListener:M,emptyStateValue:T,hideLabel:N,hideRequiredMark:ee,labelWidth:fe,modelPropName:pe,wrapperClass:we,...q,commonComponentProps:f,componentProps:q.componentProps,controlClass:I(p,q.controlClass),formFieldProps:{...S,...q.formFieldProps},formItemClass:I("flex-shrink-0",{hidden:Fe},J,q.formItemClass),labelClass:I(L,q.labelClass)}})});return(v,f)=>(w(),_(ce(i.value),W(K(d.value)),{default:C(()=>[me("div",{ref_key:"wrapperRef",ref:c,class:Z([v.wrapperClass,"grid"])},[(w(!0),x(be,null,Be(h.value,p=>(w(),_(tn,D({key:p.fieldName,ref_for:!0},p,{class:p.formItemClass,rules:p.rules}),{default:C(b=>[R(v.$slots,p.fieldName,D({ref_for:!0},b))]),_:2},1040,["class","rules"]))),128)),R(v.$slots,"default",{shapes:o.value})],2)]),_:3},16))}}),on=A({__name:"kpu-use-form",props:{formApi:{},actionButtonsReverse:{type:Boolean},actionWrapperClass:{},fieldMappingTime:{},handleReset:{type:Function},handleSubmit:{type:Function},handleValuesChange:{type:Function},resetButtonOptions:{},showDefaultActions:{type:Boolean},submitButtonOptions:{},submitOnChange:{type:Boolean},submitOnEnter:{type:Boolean},collapsed:{type:Boolean},collapsedRows:{},collapseTriggerResize:{type:Boolean},commonConfig:{},compact:{type:Boolean},layout:{},schema:{},showCollapseButton:{type:Boolean},wrapperClass:{}},setup(e){var d,m,h,v;const t=e,n=(m=(d=t.formApi)==null?void 0:d.useStore)==null?void 0:m.call(d),s=ft(t,n),{delegatedSlots:a,form:l}=Ht(s);zt([s,l]),(v=(h=t.formApi)==null?void 0:h.mount)==null||v.call(h,l);function c(f){var p;(p=t.formApi)==null||p.setState({collapsed:!!f})}function o(f){var p;!n.value.submitOnEnter||!((p=s.value.formApi)!=null&&p.isMounted)||f.target instanceof HTMLTextAreaElement||(f.preventDefault(),s.value.formApi.validateAndSubmitForm())}const i=ht(async()=>{var f,p,b;(p=(f=s.value).handleValuesChange)==null||p.call(f,vt(await s.value.formApi.getValues())),n.value.submitOnChange&&((b=s.value.formApi)==null||b.validateAndSubmitForm())},300);return xe(async()=>{await ge(),oe(()=>l.values,i,{deep:!0})}),(f,p)=>(w(),_(u(sn),D(u(s),{collapsed:u(n).collapsed,"component-bind-event-map":u(Ve),"component-map":u(de),form:u(l),"global-common-config":u(Ue),onKeydown:pt(o,["enter"])}),Ze({default:C(b=>[R(f.$slots,"default",W(K(b)),()=>[u(s).showDefaultActions?(w(),_(Wt,{key:0,"model-value":u(n).collapsed,"onUpdate:modelValue":c},{"reset-before":C(g=>[R(f.$slots,"reset-before",W(K(g)))]),"submit-before":C(g=>[R(f.$slots,"submit-before",W(K(g)))]),"expand-before":C(g=>[R(f.$slots,"expand-before",W(K(g)))]),"expand-after":C(g=>[R(f.$slots,"expand-after",W(K(g)))]),_:3},8,["model-value"])):$("",!0)])]),_:2},[Be(u(a),b=>({name:b,fn:C(g=>[R(f.$slots,b,W(K(g)))])}))]),1040,["collapsed","component-bind-event-map","component-map","form","global-common-config"]))}});function an(e){const t=bt(e),n=new Zt(e),s=n;s.useStore=l=>gt(n.store,l);const a=A((l,{attrs:c,slots:o})=>(yt(()=>{n.unmount()}),n.setState({...l,...c}),()=>ve(on,{...l,...c,formApi:s},o)),{inheritAttrs:!1,name:"KpuUseForm"});return t&&oe(()=>e.schema,()=>{n.setState({schema:e.schema})},{immediate:!0}),[a,s]}Lt({config:{modelPropNameMap:{Upload:"fileList",CheckboxGroup:"model-value"}},defineRules:{required:(e,t,n)=>e==null||e.length===0?Ee("ui.formRules.required",[n.label]):!0,selectRequired:(e,t,n)=>e==null?Ee("ui.formRules.selectRequired",[n.label]):!0}});const pn=an;export{Dt as S,pn as u};
